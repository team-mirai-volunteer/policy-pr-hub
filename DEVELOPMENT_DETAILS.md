# 政策プルリク活用ハブ 開発詳細

このドキュメントは、政策プルリク活用ハブの開発に関する追加情報を提供します。READMEに記載するほどではないが、開発者にとって有用な情報をここに記録します。

## 開発状況

現在のプロジェクトは初期段階にあり、主要な機能は実装されていますが、フロントエンド部分などはまだ計画段階です。GitHub Actionsを使用した自動化が一部実装されています。

## 技術スタックの詳細

### バックエンド
- Python 3.10以上
- 主要ライブラリ:
  - requests: GitHub API通信
  - pyyaml: 設定ファイル処理
  - backoff: API呼び出しの再試行
  - click: コマンドラインインターフェース
  - jinja2: テンプレート処理

### フロントエンド
現在、フロントエンド部分は実装されていません。将来的にWebアプリケーションとして開発する可能性があります。技術スタックは未定ですが、TypeScriptを使用する可能性があります。

## 実装上の注意点

### PRデータ収集機能
- 「未収集優先」モードは現在未実装です。更新日時順ソートで取得する方法で十分と考えられています。
- **重要**: GitHub APIのRate Limitは最大の技術的制約です。1700件以上のPRがあるため、一度にすべてのデータを取得することはできません。差分取得が必須となっています。
- 現在は`backoff`ライブラリを使用した再試行ロジックが実装されており、Rate Limitに達した場合は自動的に待機します。

### 分析機能
- 政策分野のキーワード定義は現在ハードコードされています。更新頻度が多くないため、設定ファイル化は優先度が低いと考えられています。
- セクション分析は、マークダウンファイルの見出し（`#`で始まる行）を抽出して分析します。

### レポート生成機能
- 現在はマークダウン形式のレポートを生成します。
- 将来的には、より視覚的なレポート（グラフや図表を含む）の生成も検討されています。

## 満たされていないユーザー価値

現在のシステムでは、以下のユーザー価値がまだ満たされていません：

1. **複数PRの同一箇所編集の可視化**
   - 複数のPRがファイルの同じ場所を編集している場合に、それらをまとめて確認できる機能
   - 実装方法としては、パッチ情報から変更行を抽出し、重複する箇所を検出する方法が考えられる

2. **類似PRの検出とマージ候補の提案**
   - 類似内容のPRを検出してまとめる機能
   - 完全自動化は難しいため、類似度の高いPRを検出して人間が判断するための支援機能として実装

3. **自動ラベリング機能**
   - PRを適切な担当者に割り当てるための自動ラベリング機能
   - PRの内容から政策分野を判定し、その分野の専門家に自動的にアサインする

4. **広聴AIとの連携**
   - [広聴AI](https://x.com/team_mirai_jp/status/1927668155612336591)との連携機能
   - 特に広聴AI v3.0の属性フィルタ機能を活用したPR分析
   - extractionプロンプトの改善

## テストと品質保証

現在、明確なテスト方法や品質保証の方針は定められていません。GitHub Actionsのデバッグ改善が課題として挙げられています。

## 貢献のアイデア

新しいボランティアとして貢献できる可能性のある領域:

1. GitHub Actionsのデバッグ改善
2. 「未収集優先」モードの実装
3. より視覚的なレポート生成機能の追加
4. フロントエンドWebアプリケーションの開発
5. テスト自動化の導入
6. 複数PRの同一箇所編集の可視化機能の実装
7. 類似PR検出機能の実装
8. 自動ラベリング機能の実装
9. 広聴AIとの連携機能の実装

## データ構造

収集されたPRデータは以下の構造でJSONファイルとして保存されます:

```json
{
  "basic_info": {
    "number": 123,
    "title": "PRのタイトル",
    "state": "open/closed",
    "created_at": "作成日時",
    "updated_at": "更新日時",
    "closed_at": "クローズ日時",
    "merged_at": "マージ日時",
    "html_url": "PR URL",
    "user": {
      "login": "ユーザー名",
      "id": "ユーザーID",
      "html_url": "ユーザーURL"
    }
  },
  "labels": [ラベル情報],
  "comments": [コメント情報],
  "review_comments": [レビューコメント情報],
  "files": [変更ファイル情報],
  "commits": [コミット情報],
  "collected_at": "データ収集日時"
}
```

## 関連リポジトリの詳細

- **team-mirai/policy**: 実際の政策提案PRが集まるリポジトリ
- **team-mirai-volunteer/pr-data**: 収集されたPRデータの保存先。コードと分離して、データのみを保存
- **digitaldemocracy2030/idobata**: 「いどばた政策」システムのリポジトリ。policy-editモジュールが政策提案の仕組みを提供
